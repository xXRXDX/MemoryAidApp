(function(){function read(k,d){try{return JSON.parse(localStorage.getItem(k))||d;}catch(e){return d;}}function write(k,v){localStorage.setItem(k,JSON.stringify(v));}let total=Number(localStorage.getItem('stm_timer_total'))||25*60;let remaining=Number(localStorage.getItem('stm_timer_remaining'))||total;let running=false;let interval=null;function format(s){const m=Math.floor(s/60);const sec=s%60;return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');}function initUI(){const display=document.getElementById('timer-display')||createTimerDisplay();display.textContent=format(remaining);if(!document.getElementById('ft-start')){const controls=document.getElementById('timer-controls')||(function(){const c=document.createElement('div');c.id='timer-controls';c.className='timer-controls';document.querySelector('.page-content')?.appendChild(c);return c;})();controls.innerHTML='<div id="timer-progress-wrap"><div id="timer-progress-bar" style="width:0%"></div></div><div style="display:flex;gap:8px;margin-top:8px"><button id="ft-start">Start</button><button id="ft-pause">Pause</button><button id="ft-finish">Finish Task</button><button id="ft-ar">ðŸ“¸ AR Photo</button></div><div style="margin-top:8px">XP: <span id="xp-display">0</span> Level: <span id="level-display">1</span></div>';}document.getElementById('ft-start').addEventListener('click',startTimer);document.getElementById('ft-pause').addEventListener('click',pauseTimer);document.getElementById('ft-finish').addEventListener('click',finishTask);document.getElementById('ft-ar').addEventListener('click',openAR);updateProgress();updateXP();if(window.location.hash==='#start'&&localStorage.getItem('stm_task_locked')==='1'){startTimer();}}function createTimerDisplay(){const wrap=document.querySelector('.page-content')||document.body;const d=document.createElement('div');d.id='timer-display';d.className='timer-display';d.style.fontSize='44px';d.style.fontWeight='700';d.style.textAlign='center';wrap.insertBefore(d,wrap.firstChild);return d;}function updateProgress(){const bar=document.getElementById('timer-progress-bar');if(bar){const perc=Math.round((1-remaining/total)*100);bar.style.width=perc+'%';}const disp=document.getElementById('timer-display');if(disp)disp.textContent=format(remaining);}function startTimer(){if(running)return;running=true;interval=setInterval(()=>{if(remaining>0){remaining-=1;localStorage.setItem('stm_timer_remaining',remaining);updateProgress()}else{clearInterval(interval);running=false;completeSession()}},1000);}function pauseTimer(){if(interval){clearInterval(interval);interval=null;running=false;localStorage.setItem('stm_timer_remaining',remaining);}}function finishTask(){const elapsed=total-remaining;const ratio=Math.max(0,Math.min(1,elapsed/total));const gained=Math.round(20*ratio);awardXPToCurrentTask(gained);localStorage.removeItem('stm_task_locked');localStorage.removeItem('stm_current_task');remaining=total;localStorage.removeItem('stm_timer_remaining');updateProgress();updateXP();alert('Task finished! +' + gained + ' XP');}function completeSession(){awardXPToCurrentTask(20);localStorage.removeItem('stm_task_locked');localStorage.removeItem('stm_current_task');remaining=total;localStorage.removeItem('stm_timer_remaining');updateProgress();updateXP();alert('Focus session complete! +20 XP');}function awardXPToCurrentTask(amount){const task=read('stm_current_task',{});const realm=task.realm||'wisdom';const realms=read('stm_realms',[{id:'wisdom',xp:0,level:1},{id:'strength',xp:0,level:1},{id:'spirit',xp:0,level:1}]);let r=realms.find(x=>x.id===realm);if(!r){r=realms[0];realms.push(r);}r.xp=(r.xp||0)+amount;while(r.xp>=100){r.xp-=100;r.level=(r.level||1)+1;}write('stm_realms',realms);}function openAR(){let modal=document.getElementById('ar-modal');if(modal){modal.style.display='flex';return;}modal=document.createElement('div');modal.id='ar-modal';modal.style.position='fixed';modal.style.left=0;modal.style.top=0;modal.style.right=0;modal.style.bottom=0;modal.style.background='rgba(0,0,0,0.6)';modal.style.display='flex';modal.style.alignItems='center';modal.style.justifyContent='center';modal.style.zIndex=10000;modal.innerHTML='<div style="background:#fff;padding:12px;border-radius:10px;max-width:720px;width:90%"><video id="ar-video" autoplay playsinline style="width:100%;"></video><canvas id="ar-canvas" style="display:none"></canvas><div style="margin-top:8px;display:flex;gap:8px;justify-content:center"><button id="ar-capture">Capture</button><button id="ar-close">Close</button></div></div>';document.body.appendChild(modal);const video=modal.querySelector('#ar-video');const canvas=modal.querySelector('#ar-canvas');let stream=null;navigator.mediaDevices.getUserMedia({video:true,audio:false}).then(s=>{stream=s;video.srcObject=s;}).catch(()=>{alert('Camera unavailable');});modal.querySelector('#ar-close').addEventListener('click',()=>{modal.style.display='none';if(stream)stream.getTracks().forEach(t=>t.stop());});modal.querySelector('#ar-capture').addEventListener('click',()=>{canvas.width=video.videoWidth;canvas.height=video.videoHeight;const ctx=canvas.getContext('2d');ctx.drawImage(video,0,0);ctx.font='48px serif';ctx.fillText('âœ¨',canvas.width-100,80);const data=canvas.toDataURL('image/png');const feed=read('stm_feed',[]);const task=read('stm_current_task',{});feed.unshift({img:data,caption:(task.title?task.title+' - proof':''),ts:Date.now()});write('stm_feed',feed);alert('Captured and saved to feed');modal.style.display='none';if(stream)stream.getTracks().forEach(t=>t.stop());});}function updateXP(){const realms=read('stm_realms',[]);const totalXP=realms.reduce((s,r)=>s+(r.xp||0),0);const xpEl=document.getElementById('xp-display');if(xpEl)xpEl.textContent=totalXP;const lvlEl=document.getElementById('level-display');if(lvlEl)lvlEl.textContent=realms.reduce((s,r)=>s+(r.level||1),0);}document.addEventListener('DOMContentLoaded',function(){initUI();if(localStorage.getItem('stm_task_locked')==='1'&&localStorage.getItem('stm_timer_remaining')){remaining=Number(localStorage.getItem('stm_timer_remaining'));}updateXP();});window.stmTimer={startTimer:startTimer,pauseTimer:pauseTimer,finishTask:finishTask,openAR:openAR,awardXPToCurrentTask:awardXPToCurrentTask};})();